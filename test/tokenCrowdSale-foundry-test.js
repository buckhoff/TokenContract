<full code from earlier, restored manually>